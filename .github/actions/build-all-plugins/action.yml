name: 'Build All Plugins'
description: 'Build all contrib plugins for specified OS and architecture'

inputs:
  os:
    description: 'Target OS (linux, darwin, freebsd)'
    required: true
  arch:
    description: 'Target architecture (amd64, arm64, arm, mipsle)'
    required: true
  go-version:
    description: 'Go version to use'
    required: true
    default: 'stable'

outputs:
  artifact-name:
    description: 'Name for the artifact'
    value: 'stunmesh-plugins-${{ inputs.os }}-${{ inputs.arch }}'

runs:
  using: 'composite'
  steps:
    - uses: actions/setup-go@v5
      with:
        go-version: ${{ inputs.go-version }}

    - name: Build All Plugins (Linux/Darwin)
      if: inputs.os != 'freebsd'
      shell: bash
      run: |
        # Unset APP to avoid conflicts with workflow-level env.APP
        unset APP
        mkdir -p plugins_dist
        for plugin_dir in contrib/*/; do
          if [ -f "${plugin_dir}Makefile" ]; then
            plugin_name=$(basename "$plugin_dir")
            echo "Building plugin: $plugin_name"
            cd "$plugin_dir"
            make build
            # Move built binary to output directory
            if ls stunmesh-* 1> /dev/null 2>&1; then
              mv stunmesh-* ../../plugins_dist/
              echo "✓ Moved binary to plugins_dist/"
            else
              echo "✗ Warning: No binary found for $plugin_name"
            fi
            cd ../..
          fi
        done
        echo "=== Contents of plugins_dist/ ==="
        ls -lah plugins_dist/ || echo "plugins_dist/ is empty or does not exist"
      env:
        GOARCH: ${{ inputs.arch }}
        GOOS: ${{ inputs.os }}

    - name: Build All Plugins (FreeBSD)
      if: inputs.os == 'freebsd'
      uses: vmactions/freebsd-vm@v1
      with:
        arch: ${{ inputs.arch }}
        sync: sshfs
        prepare: |
          pkg install -y gmake go
        run: |
          cd $GITHUB_WORKSPACE
          # Unset APP to avoid conflicts with workflow-level env.APP
          unset APP
          mkdir -p plugins_dist
          for plugin_dir in contrib/*/; do
            if [ -f "${plugin_dir}Makefile" ]; then
              plugin_name=$(basename "$plugin_dir")
              echo "Building plugin: $plugin_name"
              cd "$plugin_dir"
              gmake build
              # Move built binary to output directory
              mv stunmesh-* ../../plugins_dist/ 2>/dev/null || true
              cd ../..
            fi
          done
