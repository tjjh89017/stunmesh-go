name: 'Build Application'
description: 'Build the application for specified OS and architecture'

inputs:
  os:
    description: 'Target OS (linux, darwin, freebsd)'
    required: true
  arch:
    description: 'Target architecture (amd64, arm64, arm, mipsle)'
    required: true
  app-name:
    description: 'Application name'
    required: true
  go-version:
    description: 'Go version to use'
    required: true
    default: 'stable'
  tag:
    description: 'Tag to append to binary name'
    required: false
    default: ''
  variant:
    description: 'Build variant (normal or extra-min)'
    required: false
    default: 'normal'

outputs:
  binary-name:
    description: 'Name of the built binary'
    value: ${{ steps.build-info.outputs.binary-name }}

runs:
  using: 'composite'
  steps:
    - name: Set build info
      id: build-info
      shell: bash
      run: |
        SUFFIX=""
        if [ "${{ inputs.variant }}" = "extra-min" ]; then
          SUFFIX="-upx"
        fi

        if [ -n "${{ inputs.tag }}" ]; then
          BINARY_NAME="${{ inputs.app-name }}-${{ inputs.os }}-${{ inputs.arch }}-${{ inputs.tag }}${SUFFIX}"
        else
          BINARY_NAME="${{ inputs.app-name }}-${{ inputs.os }}-${{ inputs.arch }}${SUFFIX}"
        fi
        echo "binary-name=$BINARY_NAME" >> "$GITHUB_OUTPUT"

        # Set EXTRA_MIN flag
        if [ "${{ inputs.variant }}" = "extra-min" ]; then
          echo "extra-min=1" >> "$GITHUB_OUTPUT"
        else
          echo "extra-min=0" >> "$GITHUB_OUTPUT"
        fi
    
    - uses: actions/setup-go@v5
      with:
        go-version: ${{ inputs.go-version }}

    - name: Install UPX (Linux/Darwin)
      if: inputs.os != 'freebsd' && inputs.variant == 'extra-min'
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y upx-ucl

    - name: Build (Linux/Darwin)
      if: inputs.os != 'freebsd'
      shell: bash
      run: make APP=${{ steps.build-info.outputs.binary-name }} EXTRA_MIN=${{ steps.build-info.outputs.extra-min }}
      env:
        GOARCH: ${{ inputs.arch }}
        GOOS: ${{ inputs.os }}

    - name: Build (FreeBSD)
      if: inputs.os == 'freebsd'
      uses: vmactions/freebsd-vm@v1.2.4
      with:
        arch: ${{ inputs.arch }}
        sync: sshfs
        prepare: |
          pkg install -y gmake go
          if [ "${{ inputs.variant }}" = "extra-min" ]; then
            pkg install -y upx
          fi
        run: |
          cd $GITHUB_WORKSPACE
          gmake APP=${{ steps.build-info.outputs.binary-name }} EXTRA_MIN=${{ steps.build-info.outputs.extra-min }}
